{% extends "base.html" %}

{% block description %}StockVision Admin Dashboard - Manage users and view platform analytics.{% endblock %}
{% block title %}Admin Dashboard - StockVision{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block head_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<main class="dashboard">
  <div class="container">
    <!-- Dashboard Header -->
    <div class="dashboard-header fade-in">
      <h1 class="dashboard-title">Admin Dashboard</h1>
      <p class="dashboard-subtitle">Platform overview and user management</p>
    </div>

    <!-- Admin Metrics Grid -->
    <div class="metrics-grid">
      <div class="card metric-card fade-in">
        <div class="metric-icon blue">üë•</div>
        <div class="metric-content">
          <div class="metric-value" data-counter="{{ total_users }}">{{ total_users }}</div>
          <div class="metric-label">Total Users</div>
        </div>
      </div>
      <div class="card metric-card fade-in">
        <div class="metric-icon green">üìä</div>
        <div class="metric-content">
          <div class="metric-value" data-counter="{{ total_predictions }}">{{ total_predictions }}</div>
          <div class="metric-label">Total Predictions</div>
        </div>
      </div>
      <div class="card metric-card fade-in">
        <div class="metric-icon purple">‚≠ê</div>
        <div class="metric-content">
          <div class="metric-value">{{ most_used_stock }}</div>
          <div class="metric-label">Most Popular Stock</div>
        </div>
      </div>
      <div class="card metric-card fade-in">
        <div class="metric-icon orange">üî•</div>
        <div class="metric-content">
          <div class="metric-value" data-counter="{{ activity_24h }}">{{ activity_24h }}</div>
          <div class="metric-label">24h Activity</div>
        </div>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
      <div class="card chart-card fade-in">
        <div class="chart-header">
          <h3 class="chart-title">Predictions Per Day</h3>
          <p class="chart-subtitle">Last 7 days activity</p>
        </div>
        <div class="chart-wrapper">
          <canvas id="adminPredictionsPerDay"></canvas>
        </div>
      </div>
      
      <div class="card chart-card fade-in">
        <div class="chart-header">
          <h3 class="chart-title">Model Usage</h3>
          <p class="chart-subtitle">Distribution of model selections</p>
        </div>
        <div class="chart-wrapper">
          <canvas id="adminModelUsage"></canvas>
        </div>
      </div>
    </div>

    <div class="dashboard-panels">
      <div class="card dashboard-panel panel-full fade-in">
        <div class="panel-header">
          <h3 class="panel-title">User Signups Over Time</h3>
        </div>
        <div class="chart-wrapper">
          <canvas id="adminSignups"></canvas>
        </div>
      </div>
    </div>

    <!-- User Management Table -->
    <div class="dashboard-panels">
      <div class="card dashboard-panel panel-full fade-in">
        <div class="panel-header">
          <h3 class="panel-title">User Management</h3>
        </div>
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.name }}</td>
                <td>{{ user.email }}</td>
                <td><span class="role-badge {{ user.role }}">{{ user.role|title }}</span></td>
                <td><span class="status-badge {{ 'active' if user.is_active else 'inactive' }}">{{ 'Active' if user.is_active else 'Inactive' }}</span></td>
                <td class="actions">
                  {% if user.id != current_user.id %}
                    <button class="btn btn-sm btn-secondary" onclick="changeUserRole({{ user.id }}, '{{ 'admin' if user.role == 'user' else 'user' }}')">
                      Make {{ 'Admin' if user.role == 'user' else 'User' }}
                    </button>
                    {% if user.is_active %}
                      <button class="btn btn-sm btn-outline" onclick="toggleUserStatus({{ user.id }}, 'deactivate')">Deactivate</button>
                    {% else %}
                      <button class="btn btn-sm btn-success" onclick="toggleUserStatus({{ user.id }}, 'activate')">Activate</button>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">Current User</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Pass data to JS -->
<script>
  window.adminData = {
    predictionsByDay: {{ predictions_by_day|tojson }},
    modelUsage: {{ model_usage_data|tojson }},
    signupsByDay: {{ signups_by_day|tojson }}
  };
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin_dashboard.js') }}"></script>
{% endblock %}
